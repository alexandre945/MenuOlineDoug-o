<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Pedidos</title>
   <!-- pdf  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">Pedidos do Delivery</h1>
  <div id="pedidosContainer" class="space-y-4"></div>
   <div class="text-center bg-blue-500 border-green-300 p-2 rounded mt-6">
      <a href="index.html">
        <button class="text-white">VOLTAR</button>
      </a>
   </div>
  <script>
     async function carregarPedidos() {
  const container = document.getElementById("pedidosContainer");
  container.innerHTML = "Carregando...";

  try {
    const res = await fetch("/api/pedidos");
    const data = await res.json();

    if (!data.success) throw new Error("Erro ao buscar pedidos");

    container.innerHTML = "";

    const pedidos = data.pedidos || [];

      if (pedidos.length === 0) {
          container.innerHTML = `
            <div class="text-center text-gray-500 mt-10">
              <p class="text-lg font-medium">üçî Nenhum pedido no momento</p>
              <p class="text-sm text-gray-400">Aguarde novos pedidos chegarem.</p>
            </div>
          `;
          return; // sai da fun√ß√£o
        }

    pedidos.forEach(pedido => {
      const div = document.createElement("div");
      div.id = `pedido-${pedido.id}`; 
      div.className = "bg-white p-4 rounded shadow mb-4";

      const clienteNome = pedido.cliente?.nome || "-";
      const dataBruta = pedido.created_at;

    const dataPedido = dataBruta
      ? new Date(dataBruta).toLocaleString("pt-BR", {
          timeZone: "America/Sao_Paulo",
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit"
        })
      : "-";
      const clienteWhatsapp = pedido.cliente?.whatsapp || "-";
      const totalPedido = typeof pedido.total === "number" ? pedido.total.toFixed(2) : "0.00";

      // Cabe√ßalho e itens
      let html = `
        <p><strong>üõí Pedido DOUG√ÉO LANCHES</strong></p>
        <p><strong> Data: ${dataPedido}</estrong><p>
        <p><strong class="text-sm">CLIENTE:</strong> ${clienteNome}</p>
       
        <ul>
          ${(pedido.carrinho || []).map(item => {
            const precoBase = parseFloat(item.precoBase || 0);
            const precoAdicionais = parseFloat(item.precoAdicionais || 0);
            const subtotal = (precoBase + precoAdicionais) * (item.quantidade || 1);
            const opcionais = item.opcionais?.length ? ` (${item.opcionais.join(", ")})` : "";
            return `<li>(${item.quantidade || 1} )_ ${item.nome || "-"}${opcionais} - R$ ${subtotal.toFixed(2)}</li>`;
          }).join("")}
        </ul>

        <p><strong>WhatsApp:</strong> ${clienteWhatsapp}</p>
        <p><strong>Tipo de Pedido:</strong> ${pedido.tipoPedido === "entrega" ? "Entrega" : "Retirar na lanchonete"}</p>
        <p><strong>Forma de Pg:</strong> ${pedido.pagamento?.detalhe || "-"}</p>
        <p><strong>Observa√ß√£o:</strong> ${pedido.observacao || "-"}</p>
        <p><strong>Total:</strong> R$ ${totalPedido}</p>
      `;

      // Se for entrega, adiciona endere√ßo
      if (pedido.tipoPedido === "entrega" && pedido.cliente?.endereco) {
        const end = pedido.cliente.endereco;
        html += `
          <div class="mt-3 p-3 border rounded bg-gray-50">
            <p><strong>Endere√ßo de Entrega:</strong></p>
            <p><strong>Bairro:</strong> ${end.bairro || "-"}</p>
            <p><strong>Rua:</strong> ${end.rua || "-"}</p>
            <p><strong>N√∫mero:</strong> ${end.numero || "-"}</p>
            <p><strong>Refer√™ncia:</strong> ${end.referencia || "-"}</p>
          </div>
        `;
      }

      html += `
        <button
          onclick="gerarPdfPedido(${pedido.id})"
          class="mt-3 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
          Imprimir
        </button>
        <button
         onclick="excluirPedido(${pedido.id})"
         class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2">
          Excluir
        </button>
      `;

      div.innerHTML = html;
      container.appendChild(div);
    });

  } catch (err) {
    console.error("Erro ao carregar pedidos:", err);
    container.innerHTML = "Erro ao carregar pedidos: " + err.message;
  }
}

// Chamar a fun√ß√£o automaticamente
carregarPedidos();

  
//   async function gerarPdfPedido(pedidoId) {
//   const { jsPDF } = window.jspdf;

//   // Pega a div espec√≠fica do pedido
//   const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
//   if (!pedidoDiv) return alert("Pedido n√£o encontrado");

//   // Captura a div como canvas
//   const canvas = await html2canvas(pedidoDiv, { scale: 2 });

//   // Cria PDF
//   const imgData = canvas.toDataURL("image/png");
//   const pdf = new jsPDF({
//     orientation: "portrait",
//     unit: "pt",
//     format: [canvas.width, canvas.height]
//   });

//   pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
  
//   // Salva ou abre para impress√£o
//   pdf.save(`pedido_${pedidoId}.pdf`);
// }


function gerarPdfPedido(pedidoId) {
  const pedidoDiv = document.getElementById(`pedido-${pedidoId}`);
  if (!pedidoDiv) return alert("Pedido n√£o encontrado");

   // Oculta os bot√µes "Imprimir" e "Excluir"
  const botoes = pedidoDiv.querySelectorAll("button");
  botoes.forEach(botao => (botao.style.display = "none"));

  // Cria o PDF no formato menor (80mm = 3.15in aprox)
  const pdf = new jspdf.jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: [75, 400] // largura 80mm (impressora t√©rmica)
  });

  pdf.html(pedidoDiv, {
    callback: async function () {
    const blob = pdf.output("bloburl");
   
    
           
    // Exclui o pedido no backend
    try {
      const response = await fetch(`/api/pedidos/${pedidoId}`, {
        method: "DELETE"
      });
      const result = await response.json();
      if (result.success) {
        console.log(`‚úÖ Pedido ${pedidoId} exclu√≠do com sucesso!`);
          // üü¢ Mostra notifica√ß√£o visual de sucesso
          const msg = document.createElement("div");
          msg.className = "bg-green-100 text-green-700 p-3 rounded text-center fixed top-5 left-1/2 transform -translate-x-1/2 shadow-lg border border-green-300 z-50";
          msg.textContent = `‚úÖ Pedido ${pedidoId} impresso e removido com sucesso!`;
          document.body.appendChild(msg);

          // Remove a notifica√ß√£o ap√≥s 3 segundos
          setTimeout(() => msg.remove(), 3000);
      } else {
        console.warn("‚ö†Ô∏è Falha ao excluir pedido:", result);
      }
    } catch (err) {
      console.error("‚ùå Erro ao excluir pedido:", err);
    }
     window.location.href = blob; // em vez de abrir aba nova
      carregarPedidos();
            // Reexibe o bot√£o ap√≥s gerar o PDF
      if (botao) botao.style.display = "block";
    },
    x: -1, // margem esquerda
    y: 5, // margem superior
    html2canvas: {
      scale: 0.2, // reduz a escala (melhora nitidez)
      useCORS: true
    },
    width: 90 // garante que o conte√∫do caiba na largura de 80mm
  });

}

async function excluirPedido(pedidoId) {
  if (!confirm(`Tem certeza que deseja excluir o pedido ${pedidoId}?`)) return;

  try {
    const response = await fetch(`/api/pedidos/${pedidoId}`, {
      method: "DELETE"
    });

    const result = await response.json();
    if (result.success) {
      alert(`‚úÖ Pedido ${pedidoId} removido com sucesso!`);
      carregarPedidos(); // atualiza lista
    } else {
      alert("‚ö†Ô∏è Falha ao excluir pedido: " + (result.message || "Erro desconhecido"));
    }
  } catch (err) {
    console.error("‚ùå Erro ao excluir pedido:", err);
    alert("Erro ao excluir pedido: " + err.message);
  }
}


  </script>
</body>
</html>
